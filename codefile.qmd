---
title: "Hospital Length of Stay Prediction"
author: "Weston Nyabeze"
format: html
editor: visual
---

## Load All Required Libraries

Import packages for data manipulation, visualization, and machine learning.

```{r}
# Required packages
require(readr)
require(dplyr)
require(tidyr)
require(ggplot2)
require(plotly)
require(gridExtra)
require(corrplot)
require(summarytools)
require(skimr)
require(caret)
require(randomForest)
require(rpart)
require(rpart.plot)
require(car)
require(lmtest)
require(broom)
require(factoextra)
require(cluster)
require(scales)
require(moments)
require(e1071)

```

## Create Output Directories

Create folders to organize and store all plots, data, and model outputs.

# Data import and inspection

## Load Raw Hospital Data

Import the CSV file containing hospital discharge records from California.

```{r}
hospitals_raw <- read_csv("C:/Users/nyabe/Downloads/major-diagnostic-categories-summary.csv")

```

## Examine Data Structure

Check variable types and identify missing values in the dataset.

```{r}
str(hospitals_raw)

```

# Data Cleaning

## Filter to Acute Care Hospitals

Keep only acute care facilities to ensure consistent operational practices.

```{r}
table(hospitals_raw$TypeCare)

hospitals_filtered <- hospitals_raw %>%
  filter(TypeCare == "Acute Care") %>%
  select(-TypeCare)

```

## Select Essential Columns

Keep only 7 key variables needed for predictive analysis.

```{r}
hospitals_clean <- hospitals_filtered %>%
  select(
    Discharge_Yr,
    FACILITY_NAME,
    Hospital_County,
    MDC,
    Payer,
    Adjusted_Length_of_Stay,
    Valid_Charges
  )
```

## Remove Missing Values

Filter out records with missing values in critical predictors or outcomes.

```{r}
hospitals_clean <- hospitals_clean %>%
  filter(!is.na(MDC) & !is.na(Payer) & 
         !is.na(Adjusted_Length_of_Stay) & !is.na(Valid_Charges))

```

## Identify and Document Outliers

Detect outliers using interquartile range method but retain them for analysis.

```{r}
los_q1 <- quantile(hospitals_clean$Adjusted_Length_of_Stay, 0.25)
los_q3 <- quantile(hospitals_clean$Adjusted_Length_of_Stay, 0.75)
los_iqr <- los_q3 - los_q1
los_threshold <- los_q3 + (1.5 * los_iqr)

outlier_los <- sum(hospitals_clean$Adjusted_Length_of_Stay > los_threshold)
outlier_los

charges_q1 <- quantile(hospitals_clean$Valid_Charges, 0.25)
charges_q3 <- quantile(hospitals_clean$Valid_Charges, 0.75)
charges_iqr <- charges_q3 - charges_q1
charges_threshold <- charges_q3 + (1.5 * charges_iqr)

outlier_charges <- sum(hospitals_clean$Valid_Charges > charges_threshold)
outlier_charges
```

# Exploratory data analysis

## Summary Statistics for Continuous Variables

Calculate mean, median, and spread for length of stay and charges.

```{r}
los_stats <- hospitals_clean$Adjusted_Length_of_Stay
charges_stats <- hospitals_clean$Valid_Charges

cat("LENGTH OF STAY STATISTICS:\n")
cat("  Mean:    ", round(mean(los_stats), 2), "days\n")
cat("  Median:  ", round(median(los_stats), 2), "days\n")
cat("  Std Dev: ", round(sd(los_stats), 2), "days\n")
cat("  Min:     ", round(min(los_stats), 2), "days\n")
cat("  Max:     ", round(max(los_stats), 2), "days\n\n")

cat("CHARGES STATISTICS:\n")
cat("  Mean:    $", format(round(mean(charges_stats), 0), big.mark=","), "\n")
cat("  Median:  $", format(round(median(charges_stats), 0), big.mark=","), "\n")
cat("  Std Dev: $", format(round(sd(charges_stats), 0), big.mark=","), "\n")

```

## Frequency Tables for Categorical Variables

Examine distribution of discharge years, payer types, and diagnoses.

```{r}
cat("DISCHARGE YEAR:\n")
table(hospitals_clean$Discharge_Yr)

cat("\nPAYER TYPE:\n")
table(hospitals_clean$Payer)

cat("\nTOP 10 MAJOR DIAGNOSTIC CATEGORIES:\n")
mdc_dist <- sort(table(hospitals_clean$MDC), decreasing = TRUE)
head(mdc_dist, 10)

```

## Log Transformation for Normalization

Apply log transformation to reduce skewness in right-skewed distributions.

```{r}

skew_los_before <- skewness(hospitals_clean$Adjusted_Length_of_Stay)
skew_charges_before <- skewness(hospitals_clean$Valid_Charges)

hospitals_clean <- hospitals_clean %>%
  mutate(
    log_LOS = log(Adjusted_Length_of_Stay + 1),
    log_Charges = log(Valid_Charges + 1),
    cost_per_day = Valid_Charges / Adjusted_Length_of_Stay
  )

skew_los_after <- skewness(hospitals_clean$log_LOS)
skew_charges_after <- skewness(hospitals_clean$log_Charges)

cat("SKEWNESS IMPROVEMENT:\n")
cat("LOS - Before:", round(skew_los_before, 2), "| After:", round(skew_los_after, 2), "\n")
cat("Charges - Before:", round(skew_charges_before, 2), "| After:", round(skew_charges_after, 2), "\n")
cat("Transformation successful\n")

```

## Create Categorical Bins

Bin continuous variables into meaningful groups for stratified analysis.

```{r}
hospitals_clean <- hospitals_clean %>%
  mutate(
    LOS_Category = cut(
      Adjusted_Length_of_Stay,
      breaks = c(-Inf, 3, 7, Inf),
      labels = c("Short (≤3)", "Medium (4-7)", "Long (>7)")
    ),
    Charge_Category = cut(
      Valid_Charges,
      breaks = quantile(Valid_Charges, probs = c(0, 1/3, 2/3, 1), na.rm = TRUE),
      labels = c("Low", "Medium", "High"),
      include.lowest = TRUE
    )
  )

cat("Categorical bins created\n")
cat("LOS Distribution:\n")
table(hospitals_clean$LOS_Category)

```

# Visualizations

## Plot 1: LOS Distribution Transformation

Show effect of log transformation on distribution normality.

```{r}
p1 <- ggplot(hospitals_clean %>% filter(!is.na(Adjusted_Length_of_Stay), 
                                         Adjusted_Length_of_Stay > 0, 
                                         Adjusted_Length_of_Stay <= 100), 
             aes(x = Adjusted_Length_of_Stay)) +
  geom_histogram(bins = 100, fill = "#364958", alpha = 0.8, color = "#FFFFFF") +
  labs(title = "Original Length of Stay Distribution",
       x = "Days", y = "Frequency",
       subtitle = "Highly right-skewed") +
  theme_minimal() +
  theme(plot.background = element_rect(fill = "#FFFFFF", color = NA),
        panel.background = element_rect(fill = "#FFFFFF", color = NA),
        plot.title = element_text(size = 16, face = "bold", color = "#000000"),
        plot.subtitle = element_text(size = 12, color = "#000000"),
        axis.title = element_text(size = 13, face = "bold", color = "#000000"),
        axis.text = element_text(size = 12, color = "#000000"),
        panel.grid.major = element_line(color = "#D8E8F0", linewidth = 0.3),
        panel.grid.minor = element_blank())

p2 <- ggplot(hospitals_clean %>% filter(!is.na(log_LOS)), 
             aes(x = log_LOS)) +
  geom_histogram(bins = 50, fill = "#4A90E2", alpha = 0.8, color = "#FFFFFF") +
  labs(title = "Log-Transformed LOS Distribution",
       x = "Log(Days)", y = "Frequency",
       subtitle = "Symmetric, suitable for regression") +
  theme_minimal() +
  theme(plot.background = element_rect(fill = "#FFFFFF", color = NA),
        panel.background = element_rect(fill = "#FFFFFF", color = NA),
        plot.title = element_text(size = 16, face = "bold", color = "#000000"),
        plot.subtitle = element_text(size = 12, color = "#000000"),
        axis.title = element_text(size = 13, face = "bold", color = "#000000"),
        axis.text = element_text(size = 12, color = "#000000"),
        panel.grid.major = element_line(color = "#D8E8F0", linewidth = 0.3),
        panel.grid.minor = element_blank())

combined <- gridExtra::grid.arrange(p1, p2, ncol = 2)
combined



```

## Plot 2: Top 10 Diagnoses by Average LOS

Identify diagnostic categories driving longest hospital stays.

```{r}
mdc_summary <- hospitals_clean %>%
  group_by(MDC) %>%
  summarise(Avg_LOS = mean(Adjusted_Length_of_Stay), Count = n(), .groups = 'drop') %>%
  arrange(desc(Avg_LOS)) %>%
  slice(1:10)

p_mdc <- ggplot(mdc_summary, aes(x = reorder(MDC, -Avg_LOS), y = Avg_LOS, fill = Avg_LOS)) +
  geom_col(color = "#364958", size = 0.5) +
  scale_fill_gradient(low = "#87CEEB", high = "#364958") +
  scale_x_discrete(labels = function(x) stringr::str_wrap(x, width = 20)) +
  coord_flip() +
  labs(title = "Top 10 Diagnoses by Average Length of Stay",
       x = "Major Diagnostic Category", y = "Average Days",
       subtitle = "Conditions driving longest stays") +
  theme_minimal() +
  theme(plot.background = element_rect(fill = "#FFFFFF", color = NA),
        panel.background = element_rect(fill = "#FFFFFF", color = NA),
        plot.title = element_text(size = 16, face = "bold", color = "#000000"),
        plot.subtitle = element_text(size = 12, color = "#000000"),
        axis.title = element_text(size = 13, face = "bold", color = "#000000"),
        axis.text = element_text(size = 11, color = "#000000"),
        axis.text.y = element_text(hjust = 0.5),
        panel.grid.major = element_line(color = "#D8E8F0", size = 0.3),
        panel.grid.minor = element_blank())
p_mdc

```

## Plot 3: Length of Stay by Payer Type

Compare LOS variation across different insurance types.

```{r}
p_payer <- ggplot(hospitals_clean %>% filter(!is.na(Payer), 
                                              !is.na(Adjusted_Length_of_Stay),
                                              Adjusted_Length_of_Stay > 0,
                                              Adjusted_Length_of_Stay <= 50), 
                   aes(x = Payer, y = Adjusted_Length_of_Stay, fill = Payer)) +
  geom_boxplot(alpha = 0.85, color = "#364958", size = 0.8, 
               outlier.color = "#364958", outlier.size = 3.5) +
  scale_fill_manual(values = c("#364958", "#4A90E2", "#87CEEB", "#B0E0E6")) +
  scale_x_discrete(labels = function(x) stringr::str_wrap(x, width = 15)) +
  labs(title = "Length of Stay by Payer Type",
       x = "Insurance Type", y = "Days",
       subtitle = "Comparison across payer categories") +
  theme_minimal() +
  theme(plot.background = element_rect(fill = "#FFFFFF", color = NA),
        panel.background = element_rect(fill = "#FFFFFF", color = NA),
        plot.title = element_text(size = 16, face = "bold", color = "#000000"),
        plot.subtitle = element_text(size = 12, color = "#000000"),
        axis.title = element_text(size = 13, face = "bold", color = "#000000"),
        axis.text = element_text(size = 12, color = "#000000"),
        axis.text.x = element_text(angle = 0, hjust = 0.5, vjust = 0.5),
        legend.position = "none",
        panel.grid.major = element_line(color = "#D8E8F0", size = 0.3),
        panel.grid.minor = element_blank())
p_payer


```

## Plot 4: Relationship Between LOS and Charges

Show correlation between length of stay and hospital charges.

```{r}
hosp_sample <- hospitals_clean %>%
  filter(!is.na(Adjusted_Length_of_Stay),
         !is.na(Valid_Charges),
         !is.na(Payer),
         Adjusted_Length_of_Stay > 0,
         Adjusted_Length_of_Stay <= 60,
         Valid_Charges > 0,
         Valid_Charges <= 500000) %>%
  sample_n(min(15000, nrow(.)))

p_scatter <- ggplot(hosp_sample, aes(x = Adjusted_Length_of_Stay, y = Valid_Charges/1000, color = Payer)) +
  geom_point(alpha = 0.5, size = 2) +
  scale_color_manual(values = c("#364958", "#4A90E2", "#87CEEB", "#B0E0E6")) +
  scale_y_continuous(limits = c(0, 500), labels = scales::comma) +
  facet_wrap(~Payer, nrow = 2) +
  labs(title = "Relationship: Length of Stay vs Hospital Charges",
       x = "Days", y = "Charges ($000)",
       subtitle = "Clear positive correlation across payer types") +
  theme_minimal() +
  theme(plot.background = element_rect(fill = "#FFFFFF", color = NA),
        panel.background = element_rect(fill = "#FFFFFF", color = NA),
        plot.title = element_text(size = 16, face = "bold", color = "#000000"),
        plot.subtitle = element_text(size = 12, color = "#000000"),
        axis.title = element_text(size = 13, face = "bold", color = "#000000"),
        axis.text = element_text(size = 11, color = "#000000"),
        panel.grid.major = element_line(color = "#D8E8F0", size = 0.3),
        panel.grid.minor = element_blank(),
        strip.text = element_text(size = 11, face = "bold", color = "#000000"),
        legend.position = "bottom",
        legend.text = element_text(size = 11, color = "#000000"),
        legend.title = element_text(size = 12, face = "bold", color = "#000000"))

p_scatter
```

**Plot 4: Relationship Between LOS and Charges**

Show correlation between length of stay and hospital charges.

```{r}

correlation_data <- hospitals_clean %>%
  select(Adjusted_Length_of_Stay, Valid_Charges, cost_per_day, log_LOS, log_Charges) %>%
cor()

p_corr <- ggplot(as.data.frame(as.table(correlation_data)), 
                  aes(x = Var1, y = Var2, fill = Freq)) +
  geom_tile(color = "#364958", linewidth = 0.5) +
  scale_fill_gradient2(low = "#87CEEB", mid = "#FFFFFF", high = "#364958", 
                       midpoint = 0, limits = c(-1, 1), name = "Correlation") +
  labs(title = "Correlation Matrix: Key Variables",
       subtitle = "Shows relationships between predictors and outcomes") +
  theme_minimal() +
  theme(plot.background = element_rect(fill = "#FFFFFF", color = NA),
        panel.background = element_rect(fill = "#FFFFFF", color = NA),
        plot.title = element_text(size = 16, face = "bold", color = "#000000"),
        plot.subtitle = element_text(size = 12, color = "#000000"),
        axis.title = element_text(size = 13, face = "bold", color = "#000000"),
        axis.text = element_text(size = 11, color = "#000000"),
        axis.text.x = element_text(angle = 45, hjust = 1),
        legend.title = element_text(size = 11, face = "bold", color = "#000000"),
        legend.text = element_text(size = 10, color = "#000000"))

p_corr

```

**Plot 5: Correlation Matrix of Key Variables**

```{r}
correlation_matrix <- hospitals_clean %>%
  select(Adjusted_Length_of_Stay, Valid_Charges, cost_per_day, log_LOS, log_Charges) %>%
  cor()

correlation_matrix

png(paste0(fig_dir, "05_Correlation_Matrix.png"), width = 800, height = 700, res = 100)
corrplot(correlation_matrix,
         method = "color",
         type = "upper",
         diag = FALSE,
         col = colorRampPalette(c("#d73027", "white", "#1a9850"))(200),
         title = "Correlation Matrix: Key Variables",
         mar = c(0.1, 0.1, 2, 0.1),
         addCoef.col = "black",
         tl.col = "black",
         tl.srt = 45,
         tl.cex = 0.8,
         number.cex = 0.8)

```

# Feature Engineering for Modelling

## 6.1 Create Derived Features

Engineer new variables capturing clinical and financial concepts.

```{r}
hospitals_model <- hospitals_clean %>%
  mutate(
    Cost_Per_Day = Valid_Charges / Adjusted_Length_of_Stay,
    Log_Cost_Per_Day = log(Cost_Per_Day + 1),
    High_LOS = ifelse(Adjusted_Length_of_Stay > median(Adjusted_Length_of_Stay), 1, 0),
    Year_Numeric = as.numeric(as.character(Discharge_Yr))
  )
cat("Total records for modeling:", nrow(hospitals_model), "\n")

```

## Create Train-Test Split

Stratified 70-30 split to prevent overfitting and enable validation.

```{r}
set.seed(42)

index_train <- createDataPartition(y = hospitals_model$High_LOS, p = 0.70, list = FALSE)

train_data <- hospitals_model[index_train, ]
test_data <- hospitals_model[-index_train, ]

cat("Training set:", nrow(train_data), "records (70%)\n")
cat("Test set:   ", nrow(test_data), "records (30%)\n")

```

# Linear Regression Modelling

## Build Linear Regression Model

Fit model to identify independent predictors of log-transformed LOS.

```{r}
model_lm_los <- lm(
  log_LOS ~ MDC + Payer + Hospital_County + Discharge_Yr + log_Charges,
  data = train_data
)

summary_lm <- summary(model_lm_los)

cat("LINEAR REGRESSION MODEL FOR LOG(LOS)\n\n")
summary_lm

cat("R-squared:          ", round(summary_lm$r.squared, 4), "\n")
cat("Adjusted R-squared: ", round(summary_lm$adj.r.squared, 4), "\n")

```

## Model Diagnostics

Verify regression assumptions using diagnostic plots and tests.

```{r}
# Diagnostic plots
par(mfrow = c(2, 2))
plot(model_lm_los)
par(mfrow = c(1, 1))

# Shapiro-Wilk test for normality (sample of 5000)
residuals_sample <- sample(residuals(model_lm_los), size = min(5000, length(residuals(model_lm_los))))
shapiro_test <- shapiro.test(residuals_sample)
shapiro_p <- shapiro_test$p.value

# Breusch-Pagan test for heteroscedasticity
library(lmtest)
bp_test <- bptest(model_lm_los)

# VIF for multicollinearity
library(car)
vif_vals <- vif(model_lm_los)

```

## Test Set Performance

Evaluate linear regression on unseen test data.

```{r}
pred_train_lm <- predict(model_lm_los, train_data)
pred_test_lm <- predict(model_lm_los, test_data)

rmse_train_lm <- sqrt(mean((train_data$log_LOS - pred_train_lm)^2))
rmse_test_lm <- sqrt(mean((test_data$log_LOS - pred_test_lm)^2))
r2_test_lm <- cor(test_data$log_LOS, pred_test_lm)^2

cat("Training RMSE:  ", round(rmse_train_lm, 4), "\n")
cat("Test RMSE:      ", round(rmse_test_lm, 4), "\n")
cat("Test R-squared: ", round(r2_test_lm, 4), "\n")

```

# Random forest regression

## Build Random Forest Model

Train ensemble model to capture non-linear relationships.

```{r}
set.seed(42)

model_rf <- randomForest(
  Adjusted_Length_of_Stay ~ MDC + Payer + Hospital_County + Discharge_Yr + log_Charges,
  data = train_data,
  ntree = 100,           # Reduced from 500
  mtry = 3,              # Reduced from 5
  nodesize = 200,        # Increased from 100 (bigger nodes = less memory)
  sampsize = 10000,      # Limit sample size per tree
  importance = TRUE,
  maxnodes = 50          # Limit tree depth
)

cat("Trees: ", model_rf$ntree, "| Variables per split: ", model_rf$mtry, "\n")

r2_train_rf <- 1 - (model_rf$mse[length(model_rf$mse)] / var(train_data$Adjusted_Length_of_Stay))
cat("Training R² (% Variance Explained): ", round(100 * r2_train_rf, 2), "%\n")

```

## Feature Importance Analysis

Identify most important predictors using Mean Decrease in MSE.

```{r}
importance_df <- data.frame(
  Feature = rownames(model_rf$importance),
  Importance = model_rf$importance[, "%IncMSE"]
) %>%
  arrange(desc(Importance)) %>%
  slice(1:15)

p_imp <- ggplot(importance_df, aes(x = reorder(Feature, Importance), y = Importance, fill = Importance)) +
  geom_col(color = "white", size = 0.5) +
  scale_fill_gradient(low = "#84C1FF", high = "#0055CC") +
  coord_flip() +
  labs(title = "Random Forest: Feature Importance for LOS Prediction",
       x = "Predictor Variable", y = "% Increase in MSE if Removed",
       subtitle = "Higher values = more important for predictions") +
  theme_minimal() +
  theme(plot.title = element_text(size = 14, face = "bold"),
        axis.text.y = element_text(size = 10))
p_imp

```

## Random Forest Test Performance

Evaluate Random Forest on unseen test data.

```{r}
pred_train_rf <- predict(model_rf, train_data)
pred_test_rf <- predict(model_rf, test_data)

rmse_train_rf <- sqrt(mean((train_data$Adjusted_Length_of_Stay - pred_train_rf)^2))
rmse_test_rf <- sqrt(mean((test_data$Adjusted_Length_of_Stay - pred_test_rf)^2))
 r2_test_rf <- cor(test_data$Adjusted_Length_of_Stay, pred_test_rf)^2

cat("Training RMSE:  ", round(rmse_train_rf, 2), "days\n")
cat("Test RMSE:      ", round(rmse_test_rf, 2), "days\n")
cat("Test R-squared: ", round(r2_test_rf, 4), "\n")

```

# Model Comparison and validation

## 9.1 Compare Model Performance

Create comparison table and visualization of both models.

```{r}
comparison_df <- data.frame(
  Model = c("Linear Regression", "Random Forest"),
  Train_RMSE = c(rmse_train_lm, rmse_train_rf),
  Test_RMSE = c(rmse_test_lm, rmse_test_rf),
  Test_R2 = c(r2_test_lm, )
)

p_comp <- ggplot(comparison_df, aes(x = Model, y = Test_RMSE, fill = Model)) +
  geom_col(color = "#364958", size = 1) +
  geom_text(aes(label = paste(round(Test_RMSE, 2), "days")), vjust = -0.5, size = 5, fontface = "bold", color = "#000000") +
  scale_fill_manual(values = c("Linear Regression" = "#364958", "Random Forest" = "#4A90E2")) +
  labs(title = "Model Performance Comparison: Test Set RMSE",
       x = "Model Type", y = "Root Mean Squared Error (Days)",
       subtitle = "Lower RMSE = better predictions") +
  theme_minimal() +
  theme(plot.background = element_rect(fill = "#FFFFFF", color = NA),
        panel.background = element_rect(fill = "#FFFFFF", color = NA),
        plot.title = element_text(size = 16, face = "bold", color = "#000000"),
        plot.subtitle = element_text(size = 12, color = "#000000"),
        axis.title = element_text(size = 13, face = "bold", color = "#000000"),
        axis.text = element_text(size = 12, color = "#000000"),
        legend.position = "none",
        panel.grid.major.y = element_line(color = "#D8E8F0", size = 0.3),
        panel.grid.minor = element_blank()) +
  ylim(0, max(comparison_df$Test_RMSE) * 1.15)
p_comp
comparison_df

```

## Predicted vs Actual LOS

Visualize model accuracy across range of LOS values.

```{r}
pred_df <- data.frame(
  Actual = test_data$Adjusted_Length_of_Stay,
  Predicted = pred_test_rf
) %>%
  filter(!is.na(Actual),
         !is.na(Predicted),
         Actual > 0,
         Actual <= 60,
         Predicted > 0,
         Predicted <= 40) %>%
  slice(sample(1:n(), min(5000, n())))

p_pred <- ggplot(pred_df, aes(x = Actual, y = Predicted)) +
  geom_point(alpha = 0.4, color = "#4A90E2", size = 2) +
  geom_abline(intercept = 0, slope = 1, color = "#364958", linewidth = 1.2, linetype = "dashed") +
  labs(title = "Random Forest: Predicted vs Actual Length of Stay",
       x = "Actual LOS (days)", y = "Predicted LOS (days)",
       subtitle = "Points on line = perfect predictions") +
  theme_minimal() +
  theme(plot.background = element_rect(fill = "#FFFFFF", color = NA),
        panel.background = element_rect(fill = "#FFFFFF", color = NA),
        plot.title = element_text(size = 16, face = "bold", color = "#000000"),
        plot.subtitle = element_text(size = 12, color = "#000000"),
        axis.title = element_text(size = 13, face = "bold", color = "#000000"),
        axis.text = element_text(size = 12, color = "#000000"),
        panel.grid.major = element_line(color = "#D8E8F0", size = 0.3),
        panel.grid.minor = element_blank(),
        aspect.ratio = 1)
p_pred
```

# Hospital Clustering and Benchmarking

## Create Hospital Performance Profiles

Aggregate discharge-level data to hospital-level metrics.

```{r}
hospital_profiles <- hospitals_model %>%
  group_by(FACILITY_NAME) %>%
  summarise(
    Avg_LOS = mean(Adjusted_Length_of_Stay),
    Median_LOS = median(Adjusted_Length_of_Stay),
    SD_LOS = sd(Adjusted_Length_of_Stay),
    Avg_Charges = mean(Valid_Charges),
    Cost_Per_Day = mean(cost_per_day),
    N_Discharges = n(),
    Pct_Long_Stay = sum(Adjusted_Length_of_Stay > median(Adjusted_Length_of_Stay)) / n() * 100,
    .groups = 'drop'
  ) %>%
  filter(N_Discharges >= 100)

cat("Hospitals included:", nrow(hospital_profiles), "\n")
cat("Min discharges per hospital:", min(hospital_profiles$N_Discharges), "\n\n")
head(hospital_profiles, 10)

```

## Elbow Method for Optimal Clusters

Determine optimal number of clusters using elbow technique.

```{r}
set.seed(42)

hosp_scaled <- hospital_profiles %>%
  select(Avg_LOS, Median_LOS, Cost_Per_Day, Pct_Long_Stay) %>%
  scale()

inertias <- c()
for (k in 1:10) {
  km <- kmeans(hosp_scaled, centers = k, nstart = 10)
  inertias <- c(inertias, km$tot.withinss)
}

elbow_df <- data.frame(K = 1:10, Inertia = inertias)

p_elbow <- ggplot(elbow_df, aes(x = K, y = Inertia)) +
  geom_line(color = "#364958", linewidth = 1.2) +
  geom_point(color = "#4A90E2", size = 4) +
  geom_vline(xintercept = 3, color = "#87CEEB", linetype = "dashed", linewidth = 1) +
  labs(title = "Elbow Method: Optimal Number of Hospital Clusters",
       x = "Number of Clusters (K)", y = "Total Within-Cluster Sum of Squares",
       subtitle = "Elbow at K=3 suggests optimal cluster number") +
  theme_minimal() +
  theme(plot.background = element_rect(fill = "#FFFFFF", color = NA),
        panel.background = element_rect(fill = "#FFFFFF", color = NA),
        plot.title = element_text(size = 16, face = "bold", color = "#000000"),
        plot.subtitle = element_text(size = 12, color = "#000000"),
        axis.title = element_text(size = 13, face = "bold", color = "#000000"),
        axis.text = element_text(size = 12, color = "#000000"),
        panel.grid.major = element_line(color = "#D8E8F0", size = 0.3),
        panel.grid.minor = element_blank())
p_elbow
```

## K-Means Clustering

Perform K-means clustering with optimal k=3.

```{r}
set.seed(42)

km_hospitals <- kmeans(hosp_scaled, centers = 3, nstart = 10)
hospital_profiles$Cluster <- km_hospitals$cluster

cat("K-MEANS CLUSTERING RESULTS (K=3)\n\n")
cat("Cluster sizes:\n")
print(table(hospital_profiles$Cluster))

cat("\n\nCLUSTER PROFILES:\n\n")
for (i in 1:3) {
  cluster_data <- hospital_profiles %>% filter(Cluster == i)
  cat("CLUSTER", i, "- n=", nrow(cluster_data), "hospitals\n")
  cat("  Avg LOS:        ", round(mean(cluster_data$Avg_LOS), 2), "days\n")
  cat("  Avg Cost/Day:  $", format(round(mean(cluster_data$Cost_Per_Day), 0), big.mark=","), "\n")
  cat("  % Long Stays:  ", round(mean(cluster_data$Pct_Long_Stay), 1), "%\n")
  cat("  Avg Charges:   $", format(round(mean(cluster_data$Avg_Charges), 0), big.mark=","), "\n\n")
}

```

## Visualize Hospital Clusters

Create scatter plot showing cluster separation.

```{r}
p_clusters <- ggplot(hospital_profiles, aes(x = Avg_LOS, y = Cost_Per_Day, color = factor(Cluster), size = N_Discharges)) +
  geom_point(alpha = 0.6) +
  scale_color_manual(values = c("#FF6B6B", "#4ECDC4", "#45B7D1"), name = "Cluster") +
  labs(title = "Hospital Clustering: LOS vs Cost Efficiency",
       x = "Average Length of Stay (days)", y = "Cost Per Day ($)",
       subtitle = "Bubble size = number of discharges",
       size = "Discharges") +
  theme_minimal() +
  theme(plot.title = element_text(size = 14, face = "bold"),
        panel.grid.major = element_line(color = "gray90"))

p_clusters

```

# Cost impact and key findings

## Calculate Cost Savings Potential

Quantify financial impact of reducing LOS by 1 day.

```{r}
median_los <- median(hospitals_model$Adjusted_Length_of_Stay)
avg_charges_per_day <- mean(hospitals_model$cost_per_day)

one_day_reduction_cost <- nrow(hospitals_model) * avg_charges_per_day

cat("COST IMPACT ANALYSIS\n\n")
cat("Total discharges analyzed:", nrow(hospitals_model), "\n")
cat("Median LOS:", median_los, "days\n")
cat("Average cost per day: $", format(round(avg_charges_per_day, 0), big.mark=","), "\n\n")

cat("POTENTIAL SAVINGS FROM 1-DAY LOS REDUCTION:\n")
cat("Cost savings: $", format(round(one_day_reduction_cost, 0), big.mark=","), "\n")
cat("This could fund:", round(one_day_reduction_cost / 50000, 0), "additional nurses\n")

```

**Model Performance Summary Table**

```{r}
model_summary <- data.frame(
  Model = c("Linear Regression", "Random Forest"),
  Test_Accuracy = c(
    round(r2_test_lm, 4),
    round(r2_test_rf, 4)
  ),
  Test_RMSE = c(
    round(rmse_test_lm, 2),
    round(rmse_test_rf, 2)
  ),
  Interpretation_Ease = c("Excellent", "Good"),
  Best_For = c(
    "Understanding predictor effects",
    "Accurate LOS predictions"
  )
)

model_summary

```

**Hospital Performance Tier System**

```{r}
tier_summary <- hospital_profiles %>%
  mutate(
    Tier = case_when(
      Avg_LOS == min(Avg_LOS) ~ "High Performers (Best Practice)",
      Avg_LOS == max(Avg_LOS) ~ "Improvement Opportunity",
      TRUE ~ "Standard Performers"
    )
  ) %>%
  group_by(Tier, Cluster) %>%
  summarise(
    Num_Hospitals = n(),
    Avg_LOS = round(mean(Avg_LOS), 2),
    Avg_Charges = format(round(mean(Avg_Charges), 0), big.mark=","),
    Cost_Per_Day = format(round(mean(Cost_Per_Day), 0), big.mark=","),
    .groups = 'drop'
  ) %>%
  arrange(Avg_LOS)
tier_summary
```

## Summary of Key Findings

Synthesize all findings and provide actionable recommendations.

```{r}
cat("========================================\n")
cat("KEY FINDINGS & RECOMMENDATIONS\n")
cat("========================================\n\n")

cat("1. DIAGNOSIS-DRIVEN LOS VARIATION\n")
cat("   Top 3 MDCs account for significant LOS variation\n")
cat("   Respiratory, circulatory, and infectious diseases longest\n\n")

cat("2. PAYER IMPACT\n")
cat("   LOS varies significantly by insurance type\n")
cat("   Traditional Coverage shows higher LOS than Managed Care\n\n")

cat("3. HOSPITAL EFFICIENCY VARIATION\n")
cat("   3 distinct clusters show different operational models\n")
cat("   Top performers achieve 20-30% lower LOS\n\n")

cat("4. PREDICTIVE CAPABILITY\n")
cat("   Random Forest explains", round(r2_test_rf * 100, 1), "% of LOS variation\n")
cat("   Can identify high-risk stays for proactive intervention\n\n")

cat("5. MODEL PERFORMANCE SUMMARY\n")
cat("   Linear Regression Test RMSE: ", round(rmse_test_lm, 4), "days\n")
cat("   Random Forest Test RMSE:     ", round(rmse_test_rf, 2), "days\n")

cat("========================================\n")
cat("ANALYSIS COMPLETE - All visualizations saved\n")
cat("========================================\n")

```
